<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CMinor: 课程大作业任务说明文档</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">CMinor
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">课程大作业任务说明文档 </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md7"></a>
任务说明</h1>
<p>这里是 2022-2023 年春季学期**软件分析与验证**课程大作业任务说明文档，本次课程大作业的目标是完成一个具有以下功能的程序验证工具：</p>
<ul>
<li>对于给定的带有部分正确性验证标注的输入程序源码，能够返回其**部分正确性**验证的结果。</li>
<li>对于给定的带有部分正确性验证标注和秩函数的输入程序源码，能够返回其**完全正确性**验证的结果。</li>
<li>完成工具报告，大致描述你的实现过程、过程中遇到的问题以及解决方式。</li>
</ul>
<h1><a class="anchor" id="autotoc_md8"></a>
输入和输出</h1>
<p>以下是对本次大作业所需实现的程序验证工具的输入和输出的描述。</p>
<h2><a class="anchor" id="autotoc_md9"></a>
输入</h2>
<p>一个符合语法规范的，带有**前置条件**、**后置条件**、**循环不变式**、**断言**以及**秩函数**等验证标注的，文本格式的 CMinor 语言的代码文件。</p>
<p>CMinor 语言的源程序部分大致是 C 语言的子集，验证标注部分大致是 ACSL 语言的子集。</p>
<blockquote class="doxtable">
<p>&zwj;注意：秩函数是一个整型表达式或整形表达式的元组，对于带有秩函数的源码文件，我们保证其文件中所有函数及循环都被标注了秩函数，且要么所有秩函数都是一个整形表达式、要么所有秩函数的元组长度均相同。 </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md10"></a>
输出</h2>
<p>对于一个合法的输入，所实现的验证工具会在运行结束后，在其标准输出流中输出对应的验证结果。具体格式为：</p>
<ul>
<li><code>VERIFIED</code>：程序中所有验证标注均为有效的，即其部分正确（如果源码中没有秩函数）或者完全正确（如果源码中有秩函数）；</li>
<li><code>UNVERIFIED</code>：程序中并非所有验证标注都有效的，即其部分正确性（如果源码中没有秩函数）或者完全正确性（如果源码中有秩函数）不成立；</li>
<li><code>UNKNOWN</code>：程序中验证标注的有效性未知。</li>
</ul>
<h1><a class="anchor" id="autotoc_md11"></a>
实现流程</h1>
<p>验证工具的实现框图如下图所示。它包含了从程序源码到验证结果的全部流程。其中，<code>src</code> 表示程序**源代码**，<code>AST</code> 表示抽象语法树（Abstract Syntax Tree），<code>CFA</code> 表示**控制流自动机**（Control Flow Automata），<code>VC</code> 表示验证条件（Verification Condition），<code>solver</code> 表示 SMT 求解器，<code>res</code> 表示需要输出的验证结果。其中，验证条件<code>VC</code>的生成，我们使用 <code>ded-verif</code>（deductive verification）验证算法。</p>
<p>在以下框图中，从源代码（<code>src</code>）到控制流自动机（<code>CFA</code>）的部分，和本课程教授的内容关系不大。因此，在本次作业任务中，这部分的实现，已经由助教完成，并以源码的形式给出，大家可以直接使用。而从 <code>CFA</code> 到验证结果（<code>res</code>）的部分，则是本课程所教授的核心内容，需要同学们自己独立完成。</p>
<div class="fragment"><div class="line">   parser          | ded-verif    solver</div>
<div class="line">     |             |     |          |</div>
<div class="line">src ---&gt; AST ---&gt; CFA -------&gt; VCs ---&gt; res</div>
<div class="line">                   |   </div>
<div class="line">      by TA        |    by &#39;yourself&#39;</div>
<div class="line">                   |</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md12"></a>
CMinor 语言</h2>
<p>验证工具输入的源代码 <code>src</code> 使用 CMinor 语言，一种面向教学的验证语言，其形式化语法文法如 ANTLR 文法文件 <code>CMinorParser.g4</code> 和 <code>CMinorLexer.g4</code> 中所示。</p>
<p>CMinor 语言支持两种 C 中的原子类型 <code>int</code>、<code>float</code>，支持这两种原子类型的定长的*一维数组*的定义和读写，也支持以这两种原则类型为成员的结构体（<code>struct</code>），同时也支持 C 语言中最基本的**顺序**、**条件**（<code>if-then-else</code>）和**循环**（<code>while</code>、<code>for</code> 和 <code>do-while</code>）语句，以及函数。</p>
<p>以下是一个使用 CMinor 语言描述的程序的例子。在函数 <code>fun</code> 中，变量 <code>count</code> 的值从 <code>0</code> 开始不断增大 <code>1</code>，直到其值不再小于 <code>10</code>。随后，该函数将返回 <code>count</code>。</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> fun() {</div>
<div class="line">    <span class="keywordtype">int</span> count = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (count &lt; 10)</div>
<div class="line">    {</div>
<div class="line">        count = count + 1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> count;</div>
<div class="line">}</div>
</div><!-- fragment --><p>由于 CMinor 语言是验证语言，所以还会额外支持用于程序验证的标注，这些标注是一种以 <code>/*@</code> 或者 <code>//@</code> 开头的特殊的注释。</p>
<p>对于 CMinor 语言中的任意一个函数，都必须使用一阶逻辑公式标注其**前置条件**（<code>requires</code>）和**后置条件**（<code>ensures</code>）。同时，在循环头位置，也必须标注对应位置的**循环不变式**。基于前置条件和后置条件的标注，形成了一个程序**验证任务**。即证明对于所有在初始情况下，满足前置条件的程序执行路径，在其“末端”后置条件也需要满足。</p>
<p>除了前置后置条件和循环不变式外，CMinor 语言还支持对断言的标注。并且对于除数、数组下标和数组长度，会自动生成运行时断言（runtime assertion）：“除数不为零”、“数组下标非负”、“数组下标小于数组长度”。</p>
<p>在验证标注中，CMinor 支持三种数学意义上的原子类型：<code>integer</code>、<code>real</code> 和 <code>boolean</code>，类型为 C 中的 <code>int</code> 或 <code>float</code> 的程序变量，在验证标注中会被提升成类型为 <code>integer</code> 或 <code>real</code> 的数学变量，也就是说我们在验证标注中无需考虑越界和取整的问题。所有标注的逻辑公式均使用*一阶逻辑*描述，即其可以被量词（<code>\forall</code> 和 <code>\exists</code>）限定。</p>
<p>以如下的程序为例，函数 <code>fun</code> 的前置条件 为 <code>\true</code>，后置条件 为 <code>\result == 10</code>，即返回值（return value）等于 <code>10</code>。那么，对于如下的输入，程序验证工具需要证明，函数 <code>fun</code> 在任何条件下（<code>\true</code> 表示始终满足），其返回值都满足 <code>\result == 10</code>。为证明该结论，需要使用循环不变式 <code>count &lt;= 10</code>。</p>
<div class="fragment"><div class="line"><span class="comment">/*@ requires \true;</span></div>
<div class="line"><span class="comment">  @ ensures \result == 10; */</span></div>
<div class="line"><span class="keywordtype">int</span> fun() {</div>
<div class="line">    <span class="keywordtype">int</span> count = 0;</div>
<div class="line">    <span class="comment">//@ loop invariant count &lt;= 10;</span></div>
<div class="line">    <span class="keywordflow">while</span> (count &lt; 10)</div>
<div class="line">    {</div>
<div class="line">        count = count + 1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> count;</div>
<div class="line">}</div>
</div><!-- fragment --><p>为了证明程序的**完全正确性**，还需要证明程序的终止性，即程序的执行路径都是有限的。为此，CMinor 语言还支持用于证明终止性的**秩函数**的标注。秩函数是一个整形表达式或整形表达式的元组，在函数头以 <code>decreases</code> 标出，在循环头以 <code>loop variant</code> 标出。所有有效的秩函数标注的值都是**非负的**。同时，对于程序中的任意一条基本路径，在路径头标注的秩函数的值，都**严格大于**路径尾标注的秩函数的值（对于元组而言，是字典序意义上的大于）。以此便可以证明程序的任意执行路径都是有限的。</p>
<p>以如下的程序为例，函数 <code>fun</code> 入口位置标注的秩函数表达式为 <code>11</code>，而在循环入口标注的秩函数表达式为 <code>10 - count</code>。从程序入口的 <code>11</code> 到循环头的 <code>10 - count</code> 的基本路径上，可以证明秩函数表达式的值是严格下降的。同时，从循环头的 <code>10 - count</code> 到其自身的基本路径上，由于经过了语句 <code>count = count + 1</code>，故秩函数表达式的值也是严格下降的。<code>11</code> 是一个自然数，由循环不变式 <code>count &lt;= 10</code> 可知 <code>10 - count</code> 的非负性，所以全体秩函数也是非负的。因此，可以判定秩函数标注的有效性，即程序的终止性。</p>
<blockquote class="doxtable">
<p>&zwj;注：在本次作业的验证任务中，对于函数头的秩函数，我们要求其非负性可以被函数的前置条件所蕴含；对于循环头的秩函数，我们要求其非负性可以被循环不变式所蕴含。 </p>
</blockquote>
<div class="fragment"><div class="line"><span class="comment">/*@ requires \true;</span></div>
<div class="line"><span class="comment">  @ decreases 11;</span></div>
<div class="line"><span class="comment">  @ ensures \result == 10; */</span></div>
<div class="line"><span class="keywordtype">int</span> fun() {</div>
<div class="line">    <span class="keywordtype">int</span> count = 0;</div>
<div class="line">    <span class="comment">/*@ loop invariant count &lt;= 10;</span></div>
<div class="line"><span class="comment">      @ loop variant 10 - count; */</span></div>
<div class="line">    <span class="keywordflow">while</span> (count &lt; 10)</div>
<div class="line">    {</div>
<div class="line">        count = count + 1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> count;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md13"></a>
控制流自动机</h2>
<p>控制流自动机是程序的一种中间表示，它将程序的控制流结构，以自动机的形式表示出来。在控制流自动机上的每一个节点是一个**程序位置**（program location），程序语句以连接各个程序位置之间的有向边的形式被表示出来。在控制流自动机中，原程序中的所有控制流语句，如 <code>if-then-else</code> 和 <code>while</code> 等，都被替换为 <code>assume</code> 语句以及相应的控制流边。其中，<code>assume</code> 语句表达的含义是，若 <code>assume</code> 的条件被满足，那么便会沿着这条边来走。</p>
<p>下图所示的是上一个例子中的 CMinor 源码的控制流自动机。其中总计有 6 个程序位置。<code>_ENTRY_LOC#1</code> 是整个控制流自动机的起始位置，在这里记录了函数的前置条件及秩函数；<code>_EXIT_LOC#6</code> 是整个控制流自动机的结束位置，函数的后置条件被记录在了这里；<code>_LOOPHEAD_LOC#1</code> 是循环头的位置。</p>
<div class="fragment"><div class="line">              _ENTRY_LOC#1</div>
<div class="line">               [requires true]</div>
<div class="line">               [decreases 11]</div>
<div class="line">                    |</div>
<div class="line">                    | count$1 = 0;</div>
<div class="line">                    |</div>
<div class="line">                    V                   </div>
<div class="line">            _LOOPHEAD_LOC#2  &lt;---------------------</div>
<div class="line">        [loop invariant (count$1 &lt;= 10)]           |</div>
<div class="line">        [loop variant (10 - count$1)]              |</div>
<div class="line">                    |                              |</div>
<div class="line">                    | _cond$1 = (count$1 &lt; 10)     |</div>
<div class="line">                    |                              |</div>
<div class="line">                    V                              |</div>
<div class="line"> --------------  _LOC#3                            |</div>
<div class="line">|                   |                              |</div>
<div class="line">| assume !_cond$1   | assume _cond$1               |</div>
<div class="line">|                   V                              |</div>
<div class="line">|                _LOC#4                            |</div>
<div class="line">|                   |                              |</div>
<div class="line">|                   | count$1 = (count$1 + 1)      |</div>
<div class="line">|                   V                              |</div>
<div class="line"> --------------&gt; _LOC#5  ——------------------------</div>
<div class="line">                    |</div>
<div class="line">                    | \result$1 = count$1</div>
<div class="line">                    |</div>
<div class="line">                    V</div>
<div class="line">               _EXIT_LOC#6</div>
<div class="line">         [ensures (\result$1 == 10)]</div>
</div><!-- fragment --><p>为了方便后续的验证，我们会对程序中的所有变量作 <a href="https://wiki.haskell.org/Alpha_conversion">alpha renaming</a>，即对变量重命名，以保证在整个程序中所有变量——哪怕它们不在同一个作用域中——都是不重名的，比如上图中的 <code>$1</code> 即是通过 alpha renaming 所得。对于函数调用、实参、条件表达式、数组长度、数组下标和除数，我们会为其新建临时变量，比如上图中的 <code>_cond$1</code>。我们在数据流图这一层中间表示中不保留结构体的概念，结构体会被以类似于“元组”的形式处理，注意这也会导致函数调用时可能会有多个返回值。</p>
<p>在我们的控制流自动机中，有四类语句：</p><ul>
<li>assign：赋值语句，包括对变量的 assign 和对数组中元素的 assign 两种</li>
<li>assert：程序断言</li>
<li>assume：守卫（guard）条件，对于会产生控制流分支的节点，其会有两条出边，两条出边上的守卫条件互补</li>
<li>function call：函数调用，保证所有参数都是变量，并且可能有多个返回值</li>
</ul>
<p>至此，从验证工具输入的源文件形式 CMinor 语言，到验证算法所依赖的程序控制流图，都已经有了一个大致的介绍。同时，在本次大作业所给出的初始代码中，也已经完成了对于以上内容的实现。同学们需要结合初始代码，以及课程所讲授的内容，完成本次课程大作业。</p>
<h1><a class="anchor" id="autotoc_md14"></a>
附加任务</h1>
<p>对于本次课程大作业而言，我们鼓励感兴趣的同学在学有余力的同时，完成一些更加进阶的验证算法。比如：</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/318446383">BMC 算法</a></li>
<li><a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2016/12/krml250.pdf">可递归逻辑函数</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/332406712">谓词抽象算法</a></li>
<li>其他自选题目...</li>
</ul>
<p>有兴趣的同学请联系助教确定选题。对于最终完成选题的作业，将会视情况给出 0-5 分的额外加分。</p>
<h1><a class="anchor" id="autotoc_md15"></a>
分数设置</h1>
<p>本次大作业占总评的 30 分。</p>
<p>分值分配</p><ul>
<li>报告：6</li>
<li>部分正确性：21<ul>
<li>公开测例：16.8</li>
<li>隐藏测例：4.2</li>
</ul>
</li>
<li>完全正确性：3<ul>
<li>公开测例：2.4</li>
<li>隐藏测例：0.6</li>
</ul>
</li>
<li>附加任务：0-5 分</li>
</ul>
<p>隐藏测例会占所有测例的 20% 的分数，保证隐藏测例只是对公开测例作微小的改动所得。你可以认为只要你完整地实现了演绎验证算法，那么你几乎不可能会有不通过的隐藏测例。</p>
<p>如果被检查出雷同，则直接以 0 分处理。</p>
<h1><a class="anchor" id="autotoc_md16"></a>
提交方式</h1>
<ul>
<li>本次作业的 DDL 是第十八周周五（6 月 23 日）。<ul>
<li>对于毕业班同学，DDL 为第十六周周日（6 月 11 日）。</li>
</ul>
</li>
<li>我们为大家在 git.tsinghua 配置了 CI（Continuous Integration, 持续集成），大家可以很方便地于其上测试公开测例。</li>
<li>报告请以 markdown 书写，并作为文件 <code>report.md</code> 置于你的项目的根目录下。</li>
<li>我们会以 DDL 前最后一次有效的（即可以完整地跑下来 CI） commit 为准，公开测例的得分可以直接在 CI 中看到，隐藏测例及报告的得分将会在后续公布。</li>
<li>注意：请将代码及报告放到 master 分支下。</li>
</ul>
<h1><a class="anchor" id="autotoc_md17"></a>
参考教材</h1>
<p>Chapter 5 of <em>The Calculus of Computation: Decision Procedures with Applications to Verification</em> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>
