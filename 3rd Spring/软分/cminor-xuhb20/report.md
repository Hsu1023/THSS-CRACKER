# 软件分析与验证 实验报告

> 徐浩博 2020010108 软件02

## 实验环境

* Windows 11
* .NET 7.0.7

## 实验内容

通过对程序的控制流图（CFA）进行分析和已经实现的 SMT 求解器：
* 对于给定的带有部分正确性验证标注的输入程序源码，能够返回其部分正确性验证的结果。
* 对于给定的带有部分正确性验证标注和秩函数的输入程序源码，能够返回其完全正确性验证的结果。

## 实验过程

### 寻找基本路径

我们需要对每个 function 均寻找基本路径；寻找基本路径的方式是宽度优先搜索BFS。根据基本路径的定义`开始于过程入口或循环头，终止于循环头、断言或过程出口`，在CFA中，与基本路径相关的关键Location有三种：

* EntryLocation
* LoopHeadLocation
* ExitLocation

具体而言，初始时，我们在队列里放置 function 的 EntryLocation，之后根据 succLocation 在 CFA 上进行 BFS，并记录经过的 Location 和 Statement路径。

当我们在 BFS 过程中遇到 HeadLocation（包括 EntryLocation 和 LoopHeadLocation）时，这意味着基本路径的终止，我们将这个路径加入到基本路径集合中；同时开启一个新的基本路径放入队列中，注意，该 HeadLocation 必须没有作为基本路径的头部放在队列中，否则会导致基本路径的重复，因此我们用一个`hasVisited`的`Hashmap`来记录当前 HeadLocation 是否作为基本路径头加入过队列。

当我们在 BFS 过程中遇到 ExitLocation 时，这意味着基本路径的终止，我们将这个路径加入到基本路径集合中。

最终，我们获得了一个函数的基本路径的全部集合。

### 部分正确性

对于部分正确性的验证，我们需要对每个基本路径进行验证，验证的方式是对每个基本路径的进行谓词变换。我们从后置条件出发，根据基本路径经过的 Location 和 Statement，逆推出每一步 CFA 的最弱前置条件，直至该路径的头。然后利用`SMTSolver`验证前置条件是否蕴含推导出的最弱前置条件，如果能够推导出，则说明该基本路径是满足部分正确性的。

在这里，我们进行了一步简化，即

### 完全正确性

对于完全正确性的验证，我们依然需要对每个基本路径进行验证。

首先我们要验证秩函数的非负性，对于函数头的秩函数，我们要求其非负性可以被函数的前置条件所蕴含；对于循环头的秩函数，我们要求其非负性可以被循环不变式所蕴含。在这里，我们直接对每个基本路径的路径头 HeadLocation 进行验证。

其次，我们要验证秩函数是下降的，即对于程序中的任意一条基本路径，在路径头标注的秩函数的值，都严格大于路径尾标注的秩函数的值（对于元组而言，是字典序意义上的大于）。验证方法是直接验证课堂讲授的验证条件$\varphi\rightarrow wp(st_1;\cdots;st_n,\delta(x)<\delta(x')[x'\rightarrow x])$.

如果这两点得到验证，则说明该基本路径是满足完全正确性的。

## 实验结果
通过了部分正确性和完全正确性的全部公开测例。

## 遇到的问题和解决方法
1. 首先是关于基本路径，有关过程调用时，很难按照传统的基本路径定义来处理，于是我们就忽略过程调用作为基本路径结尾的情况，然后在其他基本路径中特别处理过程调用。比如在部分正确性时，$st_1;\cdots, st_k;call\_stmt;st_{k+1};\cdots;st_n$，我们直接将函数调用的最弱前置条件定义为$wp(call\_stmt;st_{k+1};\cdots,\psi)=\psi_f\rightarrow wp(st_{k+1};\cdots;st_n,\psi)\wedge \varphi_f$，其中$\varphi_f$和$\psi_f$分别是函数的前置条件和后置条件。这种合取的方式刚好满足了与函数调用有关的两个基本路径，一个对应函数调用的前置条件，一个对应函数调用返回后的情况。而在完全正确性时，我们只要遇到函数调用，就沿着路径判断是否秩函数满足下降性即可。
2. 项目框架较为复杂，且对于C#语言不够熟悉，导致在实现过程中遇到了很多问题，比如对于Statement的处理，对于循环的处理，对于函数调用的处理等等。这些问题都是通过查阅文档和调试解决的。在文档查阅不清楚的情况下，我还通过阅读源码并尝试性通过控制台标准输出调试来理解框架的运行机制。
3. 通过了部分正确性的测试后，我发现在完全正确性的测试中，有一个测试用例无法通过，经过调试发现并未判定秩函数的非负性；然而假如秩函数初始时为负的，那么即使秩函数下降，循环或者过程调用也无法停止。这说明自己对于终止性的细节还有疏忽之处。在保证了秩函数的非负性后，该测试用例通过了。